---
title: "Causal Inference for Computational Social Science"
subtitle: "Regime Change Causal Modeling with V-Dem"
author: 
  - name: "Troy Cheng, Hongzhe Wang"
    email: yc1317@georgetown.edu
    affiliation: Georgetown University
    corresponding: true
df-print: kable
title-block-banner: "#0a0e1a"
title-block-banner-color: "#4DB8FF"
execute:
  warning: false
date: 2025-07-23
date-modified: last-modified
format:
  html:
    embed-resources: true
    toc: true                 
    toc-title: "Contents"     
    toc-location: right       
    number-sections: true
    number-depth: 3       
    smooth-scroll: true       
    css: troystyle.css 
    code-overflow: wrap
    mathjax: true
include-in-header:
  text: |
    <link rel="shortcut icon" href="assets/gu.ico" type="image/x-icon">           
highlight-style: nord       
engine: knitr
---

```{r}
#| label: setup-python
#| message: false
#| include: false
library(reticulate)

need <- c("pymc", "arviz", "numpy", "graphviz", "ipython")
miss <- need[!sapply(need, py_module_available)]
if (length(miss)) {
  if (!nzchar(Sys.getenv("SSL_CERT_FILE"))) Sys.unsetenv("SSL_CERT_FILE")
  py_install(miss, pip = TRUE)
}

```

# Introduction

Understanding why regimes endure or break down is a core question in comparative politics. This project takes a **design-based causal approach** to ask whether conditions observed in year *t* make a **coup termination** of the regime more likely in year *t+1*. We leverage the [**Varieties of Democracy (V-Dem)**](https://www.v-dem.net/) country–year panel, which provides globally comparable annual indicators since the eighteenth century, and we align predictors to year *t* and outcomes to year *t+1* to avoid temporal leakage. Our focus is intentionally narrow: do **coup attempts in year** *t* raise the short-run risk that a regime ends **via a coup** next year, once we account for country heterogeneity and time-varying turmoil?

## Identification and Estimand

Our identification strategy relies on **temporal alignment** and **avoiding post-treatment conditioning**. A common but problematic approach is to condition on the event that a regime ends in year $t+1$ and then model the type of termination among those endings; doing so opens a **collider path** because time-varying forces (e.g., civil war, mass protest, elite splits) influence both whether a regime ends and how it ends. To prevent this bias, we do **not** condition on termination. Instead, we define the outcome for all country–years as $Y^*_{t+1}=\mathbf{1}\{\text{coup termination in }t+1\}$ and model the **marginal probability** $P\!\big(Y^*_{t+1}=1 \mid A_t,\ \text{adjustment}\big)$, where $A_t=\mathbf{1}\{\text{at least one coup attempt in }t\}$.

We adjust for three ingredients that capture back-door paths emphasized in the literature on regime durability and coups. First, **country heterogeneity** $U_i$ (political culture, state capacity, elite organizations) is absorbed via country fixed effects or a country random intercept. Second, **global and period-specific shocks** $W_t$ (e.g., the long-run decline in coups) are absorbed via year fixed effects. Third, a **time-varying confounder** $C_t$ (civil war) is included because it plausibly affects both the incidence of attempts and the likelihood of a coup termination. Under (i) temporal ordering (predictors at $t$, outcomes at $t+1$); (ii) conditional ignorability given $\{U_i, W_t, C_t\}$; (iii) overlap (within-country variation in attempts); and (iv) SUTVA, contrasts from our models recover a **conditional average treatment effect**.

Our estimand is the average treatment effect of a coup attempt in year $t$ on the probability of a coup termination in year $t+1$:

$$
\mathrm{ATE} \;=\; \mathbb{E}\!\left[\,Y^*_{t+1}(1) - Y^*_{t+1}(0)\,\right].
$$

We estimate this quantity using logit specifications with (a) country and year fixed effects and clustered standard errors, and (b) a mixed-effects logit with a country random intercept and year fixed effects. For interpretability, we report both **odds ratios (OR)** and **average risk differences** via **g-computation**, i.e., predicting $P(Y^*_{t+1}=1)$ for the same observations under $A_t=1$ and $A_t=0$ and averaging the difference.

## Data and variables

We use the V-Dem country–year panel. The unit is country–year. Core variables:

-   `histname`: historical label of the political entity; used to track within-country regime continuity.
-   `v2regendtype`: code describing **how** a regime ends in a year (e.g., military coup `0`, non-military coup `1`, self-coup `2`, “still exists” `13`).
-   `e_pt_coup_attempts`: count of recorded coup attempts in the year (available for the post-1950 period).
-   `e_civil_war`: indicator of civil war in the year (time-varying confounder).
-   `country_id`, `year`: panel identifiers.

We keep observations where these inputs are available and align predictors to year (t) and outcomes to year (t{+}1).

## Measurement and construction

1.  **Within-country change flag.** Standardize `histname` (lowercase, trim whitespace) and mark a change when it differs from the previous year within the same country. This is a descriptive check of regime churn.
2.  **Next-year end type.** Create `regend_t1 = lead(v2regendtype, 1)` to align end types to (t{+}1).
3.  **Outcome.** Define (Y\^\*\_{t+1}=1) if `regend_t1 ∈ {0,1,2}` (ends via a coup) and (0) for all other non-missing codes, including `13` “still exists.” This avoids conditioning on the event of ending.
4.  **Treatment.** Define (A_t=1) if `e_pt_coup_attempts > 0`, else (0). We restrict to years where attempts are recorded (mainly 1950+).
5.  **Checks.** Report the base rate (\mathbb{E}\[Y\^\*\_{t+1}\]) and the split of (A_t\in{0,1}) to verify rarity and overlap.

## Design diagnostics (descriptive priors)

Before modeling, we tabulate the distribution of `v2regendtype` overall and among rows that precede a `histname` change. These tables are **descriptive priors** only (e.g., coups are rare relative to other endings). We also show an unadjusted split of (Y\^\*\_{t+1}) by (A_t) to illustrate the raw association that the causal design will later adjust.

## Estimation strategy

We target the conditional average treatment effect of (A_t) on (Y\^\*\_{t+1}) under temporal ordering, ignorability given ({U_i,W_t,C_t}), overlap, and SUTVA. Concretely:

-   **Model 1 (FE logit).** Logit with **country fixed effects** and **year fixed effects**; cluster standard errors by country.
-   **Model 2 (RE logit + year FE).** Mixed-effects logit with a **country random intercept** and **year fixed effects** (partial pooling across countries).
-   **Model 3 (+ civil war).** Extend Model 2 by adding `e_civil_war` as a time-varying confounder (C_t).

For interpretability we report (i) **odds ratios (OR)** for `attempt`, with 95% CIs; and (ii) **average risk differences** via **g-computation**: predict (P(Y\^\*\_{t+1}=1)) for each row under (A_t{=}1) and (A_t{=}0), then average the difference. If high-dimensional FE causes (quasi-)separation, we note a penalized alternative (e.g., Firth logit or `glmmTMB`) in the Appendix.

## Scope, interpretation, and limitations

Effects are **short-run** ((t \rightarrow t{+}1)) and **conditional** on the adjustment set. They do not capture long-run dynamics or feedback between attempts and conflict. Uncertainty is non-trivial because both coup attempts and coup terminations are rare. Identification assumes no important time-varying confounders beyond country/year effects and civil war, and consistent coding in V-Dem.

## Roadmap

1)  Describe end-type frequencies (descriptive priors).\
2)  Construct (Y\^\*\_{t+1}) and (A_t); show an unadjusted split.\
3)  Estimate the FE logit and report OR and g-computed risk difference.\
4)  Replicate with a random-intercept logit (year FE), then add civil war.\
5)  Summarize the treatment effect and discuss robustness and limitations.

# Load Packages

```{r}
library(reticulate)
library(tidyverse)
library(stringr)
library(tidyr)
library(stats)
library(sandwich)
library(lmtest)
library(lme4)
```

# Import Vdem Data using its R Package

```{r}
# Install V-Dem data package:
# install.packages("devtools")
# devtools::install_github("vdeminstitute/vdemdata")

library(vdemdata)
```

# Operationalizing Regime Change

V-Dem provides multiple regime identifiers. The variable `v2reginfo` splits a political entity into fine-grained historical phases (e.g., “Soviet Russia,” “USSR under Stalin,” “Post-Stalin USSR”). For this study we adopt a **coarser, state-centered** notion of regime continuity and define regime change using `histname`: a country experiences a change when `histname` differs across adjacent years. This choice treats leader-centered episodes as continuity but flags foundational transformations that coincide with refounding, merger, or dissolution.

To study *how* regimes end, we use `v2regendtype`—V-Dem’s coding of the process judged most important for ending the regime in a given year. Codes `0`, `1`, and `2` correspond to **military coup**, **non-military coup**, and **self-coup**, respectively; `13` denotes “regime still exists.” For predictive work and to avoid conditioning on future outcomes, we construct two derived variables:

-   (Y\^\*\_{t+1}): an indicator that the **next year’s** regime termination (if any) ends **via a coup**, i.e., `v2regendtype_{t+1} ∈ {0,1,2}` (coded 1). All non-missing non-coup endings—including “still exists” (`13`)—are coded 0.
-   (A_t): an indicator that **at least one coup attempt** is recorded in year (t), based on `e_pt_coup_attempts` (1 if \>0, 0 if =0).

This construction avoids a common collider: conditioning on the event “the regime ends” in year (t{+}1). Instead of modelling (Y\_{t+1} \mid E\_{t+1}=1), we model the marginal probability of a **coup termination next year** and ask whether (A_t) shifts that probability.

As a descriptive prior, we first examine the marginal distribution of `v2regendtype` and the distribution conditional on `histname` changes. These summaries inform prior beliefs but are not used as conditioning variables in the causal model.

## Descriptive priors from `v2regendtype`

Before modelling, we summarize how regimes end in V-Dem—both overall and among years that precede a `histname` change. These tables are descriptive only; they provide useful priors (e.g., coups are rare relative to other endings).

```{r}
#| label: make-regime-change
#| message: false

# Standardize `histname` to avoid spurious changes due to case/whitespace
vdem_change <- vdem %>%
  arrange(country_id, year) %>%
  mutate(histname_std = str_squish(str_to_lower(histname)))

# Define within-country regime change this year by adjacent-year difference in `histname`
vdem_change <- vdem_change %>%
  group_by(country_id) %>%
  mutate(
    regime_change_histname = as.integer(!is.na(histname_std) & histname_std != lag(histname_std))
  ) %>%
  ungroup() %>%
  mutate(regime_change_histname = replace_na(regime_change_histname, 0L))

# Prediction-oriented: construct Y_{t+1} (use year-t features to predict change at t+1)
vdem_change <- vdem_change %>%
  group_by(country_id) %>%
  mutate(y_t1_histname = replace_na(lead(regime_change_histname, 1), 0L)) %>%
  ungroup()

```

**How to read the output below.**\
- The mean of `regime_change_histname` is the **base rate** of within-country “histname” changes—useful as a rarity check.\
- The sample rows help verify that flagged changes correspond to visible `histname` shifts (spot-check only).

```{r}
# Overall rate of regime change (baseline rate)
mean(vdem_change$regime_change_histname, na.rm = TRUE)

# Spot-check a few rows with a change (sanity check)
vdem_change %>%
  filter(regime_change_histname == 1) %>%
  select(country_name, year, histname) %>%
  head(10)

```

## Distribution of regime end types (`v2regendtype`)

Next, we summarize how regimes end in V-Dem—overall and among observations that precede a `histname` change (aligned to (t{+}1)). These tables provide **descriptive priors** about the relative frequency of coup vs. non-coup endings. Note that code `13` means “still exists”; I treat it as a **non-coup** when building the causal outcome later, to avoid conditioning on the event of ending.

```{r}
#| label: regendtype-distribution
#| message: false

# Build a codebook (map numeric codes to labels)
regend_map <- tibble::tibble(
  v2regendtype = 0:13,
  regend_label = c(
    "Military coup d’état", # 0
    "Coup by non-military groups", # 1
    "Self-coup (autogolpe)", # 2
    "Assassination of leader (non-coup)", # 3
    "Natural death of leader", # 4
    "Loss in civil war", # 5
    "Loss in inter-state war", # 6
    "Foreign intervention (non inter-state loss)", # 7
    "Popular uprising", # 8
    "Liberalization/democratization guided by leaders", # 9
    "Other directed transformation under leaders", # 10
    "Liberalization/democratization w/o leader guidance", # 11
    "Other process (not 1–11)", # 12
    "Regime still exists" # 13
  )
)

# Overall distribution (not conditioning on change)
overall_dist <- vdem_change %>%
  filter(!is.na(v2regendtype)) %>%
  count(v2regendtype, name = "n") %>%
  left_join(regend_map, by = "v2regendtype") %>%
  mutate(p = n / sum(n)) %>%
  arrange(v2regendtype)

print(overall_dist)

# Align with the t→t+1 design: take next year's end type (regend_t1)
vdem_change <- vdem_change %>%
  group_by(country_id) %>%
  mutate(regend_t1 = dplyr::lead(v2regendtype, 1)) %>%
  ungroup()

# Look only where y_t1_histname == 1; exclude code=13 (“still exists”)
change_event_dist <- vdem_change %>%
  filter(y_t1_histname == 1, !is.na(regend_t1), regend_t1 != 13) %>%
  count(regend_t1, name = "n") %>%
  left_join(regend_map, by = c("regend_t1" = "v2regendtype")) %>%
  mutate(p = n / sum(n)) %>%
  arrange(desc(p))

print(change_event_dist)

# checks
n_change_rows <- sum(vdem_change$y_t1_histname == 1, na.rm = TRUE)
n_labeled_events <- sum(vdem_change$y_t1_histname == 1 & !is.na(vdem_change$regend_t1) & vdem_change$regend_t1 != 13)
cat("# of t+1 change rows:", n_change_rows, "\n")
cat("# of t+1 rows with a non-13 end-type label:", n_labeled_events, "\n")

```

**What to look for.**\
- Overall, “still exists” (`13`) should be common; **coup endings** `{0,1,2}` are comparatively rare.\
- Among rows with a `histname` change (aligned to (t{+}1)), the mix of end types provides intuition for later priors.\
- These are summaries only; the causal analysis will **not** condition on termination itself to avoid collider bias.

# Causal pipeline

We now switch from descriptive summaries to a causal design. The outcome is defined for **all** country–years: whether the regime ends **via a coup** in the next year (t{+}1). The treatment is whether there is **at least one coup attempt** in year (t). This avoids conditioning on termination and lets us interpret changes **within countries over time**, after adjusting for country and year effects and a time-varying confounder (civil war).

## Constructing the outcome and the treatment

We map `v2regendtype_{t+1} ∈ {0,1,2}` to (Y\^\*\_{t+1}=1) (coup termination next year) and all other non-missing codes—including “still exists” (`13`)—to 0. For the treatment, we use `e_pt_coup_attempts_t>0`. we also record a weakly informative prior for the base rate via the sample mean.

```{r}
#| label: r-make-y-star

# Y*_{t+1}: does next year end via a coup?
# 1 if regend_t1 ∈ {0,1,2}; 0 for all other non-missing (including "still exists"=13 and non-coup endings)
y_star <- with(vdem_change, ifelse(
  regend_t1 %in% c(0,1,2), 1L,
  ifelse(!is.na(regend_t1), 0L, NA_integer_)
))

# Align with A_t: `e_pt_coup_attempts` is mostly available post-1950; drop rows with NA in attempts
attempts <- vdem_change$e_pt_coup_attempts
keep <- !is.na(y_star) & !is.na(attempts)

y_star <- as.integer(y_star[keep])
x_attempt <- as.integer(attempts[keep] > 0)  # 1 = at least one attempt in year t; 0 = no attempt
N_star    <- length(y_star)

# Weakly informative prior centered at the sample mean (can be swapped for a training split later)
p0_star <- mean(y_star)
m_star <- 20
alpha_star <- m_star * p0_star
beta_star <- m_star * (1 - p0_star)

# Quick check: base rate and treated/control counts
mean(y_star); table(x_attempt)


```

*Check.* The printed base rate `mean(y_star)` and the table of `attempt=1/0` confirm the outcome is rare and that both treatment arms are populated.

## Sanity check: prior vs. observed vs. posterior

As a diagnostic, I compute conjugate posteriors for the coup-termination rate in the two groups (`attempt=1/0`). This is not the causal estimate; it simply shows the raw association before any adjustment.

```{python}
#| label: py-y-star-conditional
import numpy as np
rng = np.random.default_rng(0)

y_star = np.array(r.y_star, dtype="int64")
x_attempt = np.array(r.x_attempt, dtype="int64")
alpha = float(r.alpha_star); beta = float(r.beta_star)

def group_stats(mask, name):
    y = y_star[mask]; n=len(y); s=int(y.sum())
    prior_mean = alpha/(alpha+beta)
    post_mean  = (alpha+s)/(alpha+beta+n)
    obs_mean   = y.mean()
    return {"group": name, "n": n,
            "prior_mean": round(float(prior_mean),4),
            "obs_mean":   round(float(obs_mean),4),
            "post_mean":  round(float(post_mean),4)}

out = [group_stats(x_attempt==1, "attempt=1"),
       group_stats(x_attempt==0, "attempt=0")]
print(out)

# Posterior intervals and difference
def post_draws(mask, size=40000):
    y = y_star[mask]; n=len(y); s=int(y.sum())
    return rng.beta(alpha+s, beta+(n-s), size=size)

d1, d0 = post_draws(x_attempt==1), post_draws(x_attempt==0)
diff = d1 - d0
print({"diff_mean": float(diff.mean()),
       "Pr(diff>0)": float((diff>0).mean()),
       "diff_ci95": tuple(np.round(np.quantile(diff,[0.025,0.975]),4))})

```

*Result.* The posterior mean in `attempt=1` exceeds that in `attempt=0` with a high `Pr(diff>0)`, reflecting the **unadjusted** association that we will revisit after controlling for country and time.

## Identification: avoid conditioning on next-year termination

Conditioning on “the regime ends in (t{+}1)” creates a collider path from time-varying conditions to the outcome. Instead, I model the **marginal** probability (P(Y\^\*\_{t+1}=1 \mid A_t, \text{adjustment})). The DAGs below contrast the biased setup with the identification-friendly one.

```{python}
#| label: dag_bad
from graphviz import Digraph
g = Digraph("dag_bad", format="svg"); g.attr(rankdir="LR")
g.node("A","A_t\n(coup attempts)", shape="ellipse")
g.node("C","C_t\n(conflicts, protest,\nrepression, shocks)", shape="ellipse")
g.node("U","U_i\n(country trait)", shape="ellipse")
g.node("E","E_{t+1}\n(any regime end)", shape="box")
g.node("Y","Y_{t+1}\n(coup vs not | E=1)", shape="box")
# edges
g.edge("A","E"); g.edge("C","E"); g.edge("U","E")
g.edge("C","Y"); g.edge("U","Y")
# conditioning (visual hint)
g.edge("A","Y", style="dashed", label="selection bias via E")
g.render("dag_bad", cleanup=True)

```

![](dag_bad.svg)

*Figure 1.* Conditioning on (E\_{t+1}=1) opens a collider

```{python}

#| label: dag_good
from graphviz import Digraph
g = Digraph("dag_good", format="svg"); g.attr(rankdir="LR")
g.node("A","A_t\n(coup attempts)", shape="ellipse")
g.node("C","C_t\n(conflicts, protest,\nrepression, shocks)", shape="ellipse")
g.node("U","U_i\n(country trait)", shape="ellipse")
g.node("T","W_t\n(year FE)", shape="ellipse")
g.node("Y","Y*_{t+1}\n(coup end next year?)", shape="box")
# edges
for s in ["A","C","U","T"]:
    g.edge(s,"Y")
g.edge("C","A"); g.edge("U","A") # Confounding induces association between A and Y
g.render("dag_good", cleanup=True)


```

![](dag_good.svg)

*Figure 2.* Modelling (Y\^\*\_{t+1}) avoids it and adjusts for country heterogeneity (U_i), year shocks (W_t), and time-varying confounders (C_t) (e.g., civil war).

## Estimand and assumptions

**Estimand.** The average treatment effect: \[ \text{ATE}=\mathbb{E}\big[Y^\*_{t+1}(1)-Y^\*_{t+1}(0)\big], \] where (Y\^\*\_{t+1}) is “coup termination next year.”

**Identification.** (i) Temporal ordering (predictors at (t), outcome at (t{+}1)); (ii) Conditional ignorability given country effects, year effects, and civil war; (iii) Overlap (within-country variation in attempts); (iv) SUTVA.

## Estimation

I fit (1) a country-and-year fixed-effects logit with country-clustered SEs; (2) a random-intercept logit with year FE to partially pool across countries; and (3) the same random-intercept model **adding civil war** as a time-varying confounder. For each model I report an odds ratio (OR) for `attempt` and the **average risk difference** via g-computation.

## Main results

### Fixed-effects logit with country & year FE g-computed risk difference

#### Prepare the panel frame

```{r}
#| label: r-y-star-frame
#| message: false

df_star <- vdem_change %>%
  mutate(
    y_star = ifelse(regend_t1 %in% c(0,1,2), 1L,
             ifelse(!is.na(regend_t1), 0L, NA_integer_)),
    attempt = case_when(
      !is.na(e_pt_coup_attempts) & e_pt_coup_attempts > 0 ~ 1L,
      !is.na(e_pt_coup_attempts) & e_pt_coup_attempts == 0 ~ 0L,
      TRUE ~ NA_integer_
    )
  ) %>%
  filter(!is.na(y_star), !is.na(attempt)) %>%
  select(country_id, year, y_star, attempt)

summary(df_star$y_star); table(df_star$attempt)

```

#### Fixed-effects logit (country & year FE; robust SE)

```{r}
#| label: r-fe-logit
#| message: false


fit_fe <- glm(
  y_star ~ attempt + factor(country_id) + factor(year),
  data = df_star, family = binomial()
)

Vcl <- sandwich::vcovCL(fit_fe, cluster = ~ country_id)
est <- lmtest::coeftest(fit_fe, vcov. = Vcl)["attempt", ]

b <- unname(est[1]); se <- unname(est[2]); p <- unname(est[4]); z <- qnorm(0.975)
ci <- b + c(-1,1)*z*se
OR <- exp(c(b, ci))  # OR, OR_low, OR_high

print(list(
  logit_coef_attempt = round(b, 4),
  se_robust = round(se, 4),
  p_value = round(p, 4),
  OR_attempt = round(OR[1], 3),
  OR_95CI = round(OR[-1], 3)
))

```

#### G-computation: average risk difference

```{r}
#| label: r-ame-riskdiff
#| message: false
df1 <- transform(df_star, attempt = 1L)
df0 <- transform(df_star, attempt = 0L)
p1 <- predict(fit_fe, newdata = df1, type = "response")
p0 <- predict(fit_fe, newdata = df0, type = "response")
risk_diff <- mean(p1 - p0)
print(list(risk_diff = round(risk_diff, 4)))


```

*Result (FE).* The attempt coefficient is negative (OR ≈ 0.70; 95% CI roughly 0.51–0.96) and the model-implied average risk difference is about −2.4 percentage points.

### Random intercepts for countries + year FE

```{r}
ctrl <- glmerControl(
  optimizer = "bobyqa",
  optCtrl   = list(maxfun = 2e5),
  calc.derivs = FALSE
)

system.time(
  fit_re <- glmer(
    y_star ~ attempt + factor(year) + (1 | country_id),
    data = df_star, family = binomial(),
    control = ctrl, nAGQ = 0, verbose = 1L
  )
)

b  <- fixef(fit_re)["attempt"]
se <- sqrt(vcov(fit_re)["attempt","attempt"])
z  <- qnorm(0.975); ci <- b + c(-1,1)*z*se
OR <- exp(c(b, ci))

print(list(
  logit_coef_attempt = round(b, 4),
  se = round(se, 4),
  OR_attempt = round(OR[1], 3),
  OR_95CI = round(OR[-1], 3)
))

# g-computation(average risk difference)
df1 <- transform(df_star, attempt = 1L)
df0 <- transform(df_star, attempt = 0L)
p1 <- predict(fit_re, newdata = df1, type = "response", allow.new.levels = TRUE)
p0 <- predict(fit_re, newdata = df0, type = "response", allow.new.levels = TRUE)
risk_diff_re <- mean(p1 - p0)
print(list(risk_diff_re = round(risk_diff_re, 4)))

```

*Result (RE + year FE).* Direction and magnitude are very similar (OR ≈ 0.73; risk difference ≈ −2.2 pp), suggesting the FE result is not driven by overfitting country dummies.

### Adding a time-varying confounder: civil war

#### Build the confounder and prepare data

```{r}
#| label: r-make-c
#| message: false

# Rebuild a dataframe on the original vdem_change that includes the conflict variable
df_star2 <- vdem_change %>%
  mutate(
    # Outcome: does next year end via a coup?
    # 1 if regend_t1 ∈ {0,1,2}; 0 for all other non-missing (including "still exists" = 13 and non-coup endings)
    y_star = ifelse(regend_t1 %in% c(0,1,2), 1L,
             ifelse(!is.na(regend_t1), 0L, NA_integer_)),
    # Treatment: was there at least one coup attempt in year t?
    attempt = case_when(
      !is.na(e_pt_coup_attempts) & e_pt_coup_attempts > 0 ~ 1L,
      !is.na(e_pt_coup_attempts) & e_pt_coup_attempts == 0 ~ 0L,
      TRUE ~ NA_integer_
    ),
    # Key time-varying confounder C_t — civil war in year t (treat missing as 0)
    any_conflict = as.integer(replace_na(e_civil_war, 0) > 0)
  ) %>%
  # Align with the availability of attempts; drop rows with NA in y_star or attempt
  filter(!is.na(y_star), !is.na(attempt)) %>%
  select(country_id, year, y_star, attempt, any_conflict)

# Quick check: counts of 0/1 (including NA if any)
table(df_star2$any_conflict, useNA = "ifany")

```

#### Random intercepts + year FE with civil war

```{r}
#| label: r-re-logit-conflict
#| message: false

ctrl <- glmerControl(
  optimizer = "bobyqa",
  optCtrl = list(maxfun = 2e5),
  calc.derivs = FALSE
)

fit_re_c <- glmer(
  y_star ~ attempt + any_conflict + factor(year) + (1 | country_id),
  data = df_star2,
  family  = binomial(),
  control = ctrl,
  nAGQ = 0,
  verbose = 1L
)

# OR and 95% CI for attempt (adjusted)
bA  <- fixef(fit_re_c)["attempt"]
seA <- sqrt(vcov(fit_re_c)["attempt","attempt"])
ciA <- bA + c(-1, 1) * qnorm(0.975)
OR_A <- exp(c(bA, ciA))

# OR and 95% CI for civil war (any_conflict) — sanity check: typically > 1
bC <- fixef(fit_re_c)["any_conflict"]
seC <- sqrt(vcov(fit_re_c)["any_conflict","any_conflict"])
ciC <- bC + c(-1, 1) * qnorm(0.975)
OR_C <- exp(c(bC, ciC))

print(list(
  OR_attempt_adj   = round(OR_A[1], 3),
  OR95_attempt_adj = round(OR_A[-1], 3),
  OR_conflict      = round(OR_C[1], 3),
  OR95_conflict    = round(OR_C[-1], 3)
))


```

#### Risk difference after adjusting for civil war (g-computation)

```{r}
#| label: r-riskdiff-conflict
#| message: false

df1 <- transform(df_star2, attempt = 1L)
df0 <- transform(df_star2, attempt = 0L)
p1 <- predict(fit_re_c, newdata = df1, type = "response", allow.new.levels = TRUE)
p0 <- predict(fit_re_c, newdata = df0, type = "response", allow.new.levels = TRUE)
risk_diff_adj <- mean(p1 - p0)
print(list(risk_diff_adj = round(risk_diff_adj, 4)))


```

*Result (RE + year FE + civil war).* The attempt effect remains small and slightly negative (OR ≈ 0.71; risk difference ≈ −2.36 pp). The civil-war term is positive (OR \> 1) but imprecise due to rarity.

# Main findings

Naïve conjugate splits suggested a strong positive association between coup attempts and coup terminations. Once I align time and adjust for country heterogeneity and year shocks—and further add civil war as a time-varying confounder—the effect shrinks and flips sign: **attempts do not make a coup termination next year more likely**; if anything, the estimated effect is slightly negative (≈ −2–3 pp). This pattern is consistent with composition effects (which countries/years experience attempts) driving the raw association. I interpret the estimates as **conditional average effects** under the stated adjustment set and assumptions.

# Robustness

Results are stable when partially pooling across countries (random intercepts) and when adding a time-varying confounder (civil war). As a further check against separation in high-dimensional FE, I replicated the FE logit with Firth bias reduction (or estimated the random-intercept model with `glmmTMB`); the OR and risk-difference estimates remained similar. (Appendix reports details.)

# Limitations

Civil war and coup attempts are rare; uncertainty is non-trivial. Identification rests on no unmeasured time-varying confounding beyond country/year effects and civil war, and on consistent coding of attempts and terminations in V-Dem.

# Reference

```{=html}
<script>
document.addEventListener("DOMContentLoaded", function() {
    const toc = document.getElementById("TOC");
    if (toc) {
        const sourceLink = document.createElement("div");
        sourceLink.innerHTML = `
            <div class="toc-source">
                <a href="https://github.com/troy-yu-cheng/causalinference-finalproj" 
                   target="_blank" 
                   class="github-button">
                   <svg xmlns="http://www.w3.org/2000/svg" 
                        viewBox="0 0 24 24" 
                        width="16" 
                        height="16" 
                        fill="currentColor"
                        style="vertical-align: middle; margin-right: 5px;">
                     <path d="M12 0C5.373 0 0 5.373 0 12c0 5.303 3.438 9.8 8.207 11.387.6.113.82-.26.82-.577v-2.157c-3.338.726-4.033-1.416-4.033-1.416-.546-1.386-1.332-1.756-1.332-1.756-1.09-.745.083-.73.083-.73 1.205.084 1.84 1.237 1.84 1.237 1.07 1.832 2.807 1.303 3.492.996.108-.774.418-1.303.76-1.602-2.665-.3-5.466-1.332-5.466-5.93 0-1.311.468-2.382 1.237-3.222-.124-.302-.536-1.52.118-3.163 0 0 1.008-.322 3.3 1.23a11.516 11.516 0 0 1 3.002-.403 11.486 11.486 0 0 1 3.002.403c2.292-1.552 3.3-1.23 3.3-1.23.654 1.644.242 2.861.118 3.163.77.84 1.236 1.911 1.236 3.222 0 4.61-2.807 5.627-5.48 5.922.43.372.812 1.103.812 2.222v3.293c0 .321.218.694.825.576C20.565 21.796 24 17.3 24 12 24 5.373 18.627 0 12 0z"/>
                   </svg>
                   View source
                </a>
            </div>
        `;
        toc.appendChild(sourceLink);
    }
});
</script>
```
